
# תוכנית: שילוב הפעלות סימים במערכת ההשכרות הראשית

## מצב נוכחי

כיום קיימות שתי מערכות מקבילות:
1. **דף השכרות** - ניהול השכרות, לקוחות, ופריטי מלאי
2. **דאשבורד CellStation** - דף נפרד לניהול סימים והפעלות

המשתמש צריך לעבור בין שני דפים שונים לביצוע פעולות קשורות, מה שגורם לחוסר יעילות.

## הרעיון המוצע

**שילוב חכם** של הפעלות סימים ישירות בתהליך ההשכרה הקיים:

```
תהליך חדש מאוחד:
┌──────────────────┐     ┌────────────────────┐     ┌────────────────┐
│  יצירת השכרה    │ ──► │  בחירת סים מלאי   │ ──► │  שאלה אוטומטית │
│  (דף השכרות)    │     │  (סימים אירופאים)  │     │  "להפעיל סים?" │
└──────────────────┘     └────────────────────┘     └────────────────┘
                                                            │
                    ┌───────────────────────────────────────┘
                    ▼
        ┌──────────────────────┐     ┌────────────────────┐
        │  הפעלה מיידית       │ ──► │  סטטוס בזמן אמת   │
        │  (דרך Edge Function) │     │  בכרטיס ההשכרה   │
        └──────────────────────┘     └────────────────────┘
```

---

## מה יישאר מ-CellStation

1. **סנכרון מלאי** - לחיצה על "סנכרון מלאי" בדף המלאי (כבר קיים)
2. **Bookmarklet** - להפעלה בפועל באתר הספק (ללא שינוי)
3. **לשונית "צריך החלפה"** - יכולה להישאר כפונקציונליות מצומצמת או להיות מוסרת

---

## רכיבים חדשים

### 1. כפתור הפעלת סים בתוך כרטיס ההשכרה

בכל כרטיס השכרה שמכיל סים אירופאי, יופיע כפתור "הפעל סים":

```
┌────────────────────────────────────────────────────────┐
│  📦 השכרה #1234 - ישראל ישראלי                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  🇪🇺 סים אירופאי - 0722587082                         │
│      📞 מקומי: 447429123456  |  🇮🇱 ישראלי: 0722587082 │
│      תאריכים: 08/02/2026 - 15/02/2026                  │
│                                                        │
│      ┌──────────────┐  ┌──────────────┐               │
│      │ ⚡ הפעל סים │  │ 🖨️ הדפס    │               │
│      └──────────────┘  └──────────────┘               │
│                                                        │
│      סטטוס הפעלה: 🔄 ממתין לביצוע בBookmarklet        │
└────────────────────────────────────────────────────────┘
```

### 2. מצב הפעלה אוטומטית ביצירת השכרה

כאשר יוצרים השכרה חדשה עם סים אירופאי, יופיע checkbox:
- ✅ **"הפעל סים אוטומטית"** (מסומן כברירת מחדל)

אם מסומן, המערכת תשלח בקשת הפעלה אוטומטית ברגע שההשכרה נוצרת.

### 3. תצוגת סטטוס הפעלה בזמן אמת

שימוש ב-Realtime של Supabase להצגת סטטוס הפעלה:
- 🔵 **לא הופעל** - כפתור "הפעל סים" מוצג
- 🟡 **ממתין** - הבקשה נשלחה, ממתין ל-Bookmarklet
- 🟢 **הופעל** - הסים פעיל
- 🔴 **נכשל** - עם כפתור "נסה שוב"

### 4. באנר תזכורת להפעלות ממתינות

בראש דף ההשכרות, כאשר יש הפעלות ממתינות:

```
┌────────────────────────────────────────────────────────┐
│  ⚠️ יש 3 סימים ממתינים להפעלה                          │
│  לחץ על ה-Bookmarklet באתר CellStation להשלמת ההפעלה  │
│                              [פתח CellStation] [הסתר]  │
└────────────────────────────────────────────────────────┘
```

---

## שינויים טכניים

### קבצים לעדכון

| קובץ | שינוי |
|------|-------|
| `src/pages/Rentals.tsx` | הוספת באנר הפעלות ממתינות, שילוב סטטוס הפעלה בכרטיסים |
| `src/components/rentals/NewRentalDialog.tsx` | הוספת אפשרות "הפעל סים אוטומטית" |
| `src/components/SimActivationButton.tsx` | כבר קיים - ישמש בתוך כרטיסי ההשכרות |

### קבצים חדשים

| קובץ | תיאור |
|------|-------|
| `src/components/rentals/RentalSimActivation.tsx` | רכיב לניהול הפעלת סים בתוך כרטיס השכרה |
| `src/components/rentals/PendingActivationsAlert.tsx` | באנר התראה על הפעלות ממתינות |
| `src/hooks/usePendingActivations.tsx` | Hook לקבלת הפעלות ממתינות עם Realtime |

### לוגיקת הפעלה אוטומטית

כאשר נוצרת השכרה חדשה עם סים אירופאי:

```typescript
// בתוך NewRentalDialog
const [autoActivateSim, setAutoActivateSim] = useState(true);

// לאחר יצירת ההשכרה
if (autoActivateSim && hasEuropeanSim) {
  await supabase.functions.invoke('sim-activation-request', {
    body: {
      sim_number: simItem.simNumber,
      rental_id: newRentalId,
      customer_id: customerId,
      customer_name: customerName,
      start_date: startDate,
      end_date: endDate,
    }
  });
}
```

### Realtime לעדכון סטטוס

```typescript
// בתוך useRental או hook נפרד
const channel = supabase
  .channel('activation-status')
  .on('postgres_changes', {
    event: 'UPDATE',
    schema: 'public',
    table: 'sim_cards',
    filter: 'activation_status=neq.none'
  }, (payload) => {
    // עדכון UI בזמן אמת
  })
  .subscribe();
```

---

## מה קורה עם דאשבורד CellStation

### אפשרות א': צמצום לדף "ניהול סימים" מינימלי
- **נשאר**: רק הלשוניות "צריך החלפה" ו"לא בתוקף"
- **מוסר**: כל הלשוניות האחרות (הפעלות, זמינים, מושכרים)
- **יתרון**: שומר גישה מהירה לבעיות סנכרון

### אפשרות ב': הסרה מלאה
- כל הפונקציונליות עוברת לדפים הקיימים
- "צריך החלפה" הופך לפילטר בדף המלאי
- "לא בתוקף" הופך לפילטר בדף המלאי
- **יתרון**: ממשק פשוט יותר, פחות דפים

---

## יתרונות המעבר

1. **זרימת עבודה טבעית** - הפעלה כחלק מתהליך ההשכרה
2. **פחות ניווט** - אין צורך לעבור בין דפים
3. **מעקב משולב** - סטטוס הפעלה צמוד לכרטיס ההשכרה
4. **פחות הכשרה** - ממשק אחד ללמוד
5. **הפעלה אוטומטית** - פחות לחיצות ידניות

---

## שלבי יישום מוצעים

### שלב 1: הוספת סטטוס הפעלה לכרטיסי השכרות
- הצגת סטטוס הפעלה לכל סים בהשכרה
- כפתור "הפעל סים" בכרטיס ההשכרה

### שלב 2: הפעלה אוטומטית ביצירת השכרה
- Checkbox "הפעל סים אוטומטית" ב-NewRentalDialog
- שליחת בקשת הפעלה אוטומטית

### שלב 3: באנר הפעלות ממתינות
- התראה בראש דף ההשכרות
- קישור ישיר ל-CellStation

### שלב 4: צמצום/הסרת דאשבורד CellStation
- העברת פונקציונליות שנותרה
- ניקוי קוד ישן

