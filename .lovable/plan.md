
# תוכנית: שיפור מערכת התשלומים ועריכת השכרות

## סיכום מצב קיים

### מה כבר עובד:
1. **שמירת כרטיס אשראי** - בדף לקוחות ניתן להזין פרטי כרטיס שנשמרים כטוקן מאובטח
2. **שימוש בכרטיס שמור** - בדיאלוג תשלום בהשכרות יש אפשרות "השתמש בכרטיס שמור"
3. **הגדרות חיוב איחור** - בעריכת השכרה ניתן להגדיר סכום ליום, ימי חסד והפעלה אוטומטית
4. **עריכת תאריכים** - ניתן לערוך תאריך התחלה וסיום בדיאלוג עריכת השכרה

### מה חסר:
1. **תצוגה ברורה של כרטיס שמור** - אין אינדיקציה ויזואלית ברורה בכרטיס הלקוח
2. **עריכת פריטים בהשכרה** - לא ניתן להוסיף/להסיר/להחליף פריטים אחרי יצירת ההשכרה
3. **חישוב מחיר מחדש** - אין עדכון מחיר אוטומטי כשמשנים תאריכים

---

## שלב 1: שיפור תצוגת כרטיס שמור בלקוחות

### שינויים בקובץ `src/pages/Customers.tsx`:
- הוספת אייקון כרטיס אשראי ירוק בכרטיס הלקוח כשיש כרטיס שמור
- הצגת 4 ספרות אחרונות ותוקף
- אפשרות למחוק כרטיס שמור מתוך הדיאלוג

---

## שלב 2: עריכת פריטים בהשכרה קיימת

### שינויים בקובץ `src/pages/Rentals.tsx`:

**דיאלוג עריכה משופר יכלול:**

1. **רשימת פריטים נוכחיים** עם אפשרות להסיר כל פריט
2. **כפתור "הוסף פריט"** שפותח בחירה מהמלאי הזמין
3. **אפשרות להחליף פריט** (למשל החלפת סים)
4. **חישוב מחיר אוטומטי** כשמשנים תאריכים או פריטים

### מבנה נתונים:
```text
+---------------------------+
|   דיאלוג עריכת השכרה      |
+---------------------------+
| תאריך התחלה | תאריך סיום  |
+---------------------------+
| פריטים בהשכרה:            |
| [X] סים אמריקאי #12345    |
| [X] מכשיר פשוט #67890     |
| [+ הוסף פריט]             |
+---------------------------+
| סה"כ: ₪350               |
+---------------------------+
```

### לוגיקה נדרשת:
- בעת הסרת פריט: עדכון טבלת `rental_items` + החזרת הפריט למלאי
- בעת הוספת פריט: אימות זמינות + עדכון סטטוס ל-rented
- בעת שינוי תאריכים: חישוב מחדש לפי `calculateRentalPrice`

---

## שלב 3: עדכון Hook ופונקציות DB

### שינויים בקובץ `src/hooks/useRental.tsx`:

**פונקציה חדשה - `updateRentalItems`:**
```typescript
async updateRentalItems(
  rentalId: string, 
  itemsToAdd: RentalItem[], 
  itemsToRemove: string[]
): Promise<void>
```

**לוגיקת הפונקציה:**
1. מחיקת פריטים שהוסרו מ-`rental_items`
2. עדכון סטטוס פריטים שהוסרו ל-`available` ב-`inventory`
3. הוספת פריטים חדשים ל-`rental_items`
4. עדכון סטטוס פריטים חדשים ל-`rented` ב-`inventory`
5. חישוב מחיר כולל חדש ועדכון ב-`rentals`

---

## שלב 4: חישוב מחיר דינמי בעריכה

### שינויים בקובץ `src/pages/Rentals.tsx`:

- הוספת state לפריטים בעריכה: `editItems`
- שימוש ב-`useMemo` לחישוב מחיר בזמן אמת
- הצגת פירוט מחירים כמו בדיאלוג יצירת השכרה

---

## פרטים טכניים

### עדכוני DB (ללא migration - רק קוד):
הטבלאות הקיימות מספיקות:
- `rentals` - כבר יש שדה `total_price`
- `rental_items` - כבר יש `rental_id` ו-`inventory_item_id`
- `inventory` - כבר יש `status`

### טיפול במקרי קצה:
1. **הסרת כל הפריטים** - יש למנוע (חייב להישאר לפחות פריט אחד)
2. **פריט שכבר הושכר** - בדיקת זמינות בזמן אמת
3. **מניעת כפילויות** - אותו פריט לא יכול להופיע פעמיים

---

## סדר ביצוע

1. **שיפור תצוגת כרטיס שמור בכרטיסי לקוחות** (~10 שורות)
2. **הוספת state לעריכת פריטים בדיאלוג** (~30 שורות)
3. **ממשק עריכת פריטים (הצגה/הסרה/הוספה)** (~100 שורות)
4. **פונקציית `updateRentalItems` ב-useRental** (~50 שורות)
5. **חישוב מחיר דינמי בעריכה** (~30 שורות)
6. **חיבור הכל ובדיקות** 
