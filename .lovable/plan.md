
# שיפור דאשבורד CellStation - תכנון מקיף

## סקירת המצב הקיים

### מה יש כרגע:
- **4 לשוניות**: השכרות | מלאי | הפעלה חדשה | החלפת סים
- **סטטיסטיקות בסיסיות**: סה"כ השכרות, מסתיימות היום/מחר, סימים פעילים/לא פעילים
- **טבלת השכרות** עם מידע מ-Google Script בלבד
- **אינטגרציה בסיסית** עם המערכת הראשית (הצגת סטטוס)

### מה חסר:
1. קטגוריזציה ברורה לפי סטטוס **בתוקף / לא בתוקף**
2. סימון כאשר סים נמצא **באיחור** (לא הוחזר) → צריך החלפת סים
3. חובת בחירת **לקוח קיים** לפני הפעלה והשכרה
4. ממשק **חכם יותר** ונגיש

---

## העיצוב החדש

### מבנה לשוניות חדש:

```
┌─────────────────────────────────────────────────────────────────────┐
│  📊 השכרות פעילות  │  ✅ זמינים להפעלה  │  ⛔ לא בתוקף  │  ➕ הפעלה  │
└─────────────────────────────────────────────────────────────────────┘
```

1. **השכרות פעילות** - כל ההשכרות הנוכחיות עם סטטוס מהמערכת הראשית
2. **זמינים להפעלה** - סימים בתוקף שאפשר להפעיל
3. **לא בתוקף** - סימים שפג תוקפם או לא פעילים
4. **הפעלה חדשה** - טופס הפעלה משופר עם חובת בחירת לקוח

---

## שלב 1: לשונית "השכרות פעילות" משופרת

### תכונות חדשות:
- **סטטוס מהמערכת הראשית** בולט וברור עם צבעים
- **אזהרת החלפת סים** כאשר הסים מופיע כ"באיחור" ולא הוחזר

### תצוגה:

```
┌────────────────────────────────────────────────────────────────────────┐
│  לקוח         │ מספר מקומי    │ סיום CellStation │ סטטוס מערכת     │
├────────────────────────────────────────────────────────────────────────┤
│  ישראל כהן    │ 07225-123-456 │ 15/02/2026      │ 🟢 הוחזר        │
│  שרה לוי      │ 07225-789-012 │ 10/02/2026      │ 🔴 באיחור ⚠️    │
│                                │                 │ [כפתור: החלף סים]│
│  דוד מזרחי    │ 07225-345-678 │ 20/02/2026      │ 🟡 מושכר        │
└────────────────────────────────────────────────────────────────────────┘
```

### לוגיקה:
- אם הסים **באיחור** במערכת הראשית = הצג אזהרה "הסים לא הוחזר - נדרשת החלפה"
- אם הסים **הוחזר** = הצג תג ירוק "זמין להפעלה מחדש"
- אם הסים **מושכר** = הצג תג צהוב עם פרטי הלקוח הנוכחי

---

## שלב 2: לשונית "זמינים להפעלה" חדשה

### מאפיינים:
- מציגה **רק** סימים שעומדים בכל התנאים:
  1. ✅ **בתוקף** - תאריך תפוגה עתידי
  2. ✅ **פעיל** ב-CellStation
  3. ✅ **זמין במערכת הראשית** - לא מושכר או באיחור

### תצוגת כרטיסים:

```
┌─────────────────────────────────────────┐
│  🟢 07225-123-456                       │
│  ──────────────────────────────────────  │
│  📱 מספר ישראלי: 44-xxx-xxxx           │
│  📅 תוקף: 15/06/2026 (127 ימים)         │
│  📦 חבילה: 30GB Europe                   │
│  ──────────────────────────────────────  │
│  במערכת: 🟢 זמין | במלאי: ✅            │
│  ──────────────────────────────────────  │
│  [  ⚡ הפעל והשכר  ]                    │
└─────────────────────────────────────────┘
```

### סטטוס מערכת ראשית:
- 🟢 **זמין** - אפשר להפעיל מיד
- 🟡 **מושכר** - מישהו אחר משתמש, נדרשת החלפה או המתנה
- 🔴 **באיחור - נדרשת החלפה** - הסים לא הוחזר, לא ניתן להפעיל

---

## שלב 3: לשונית "לא בתוקף" חדשה

### מטרה:
לאפשר מעקב על סימים שפג תוקפם או לא פעילים

### תצוגה:

```
┌─────────────────────────────────────────────────────────────────────┐
│  מספר מקומי    │ מספר סים          │ תוקף       │ סיבה          │
├─────────────────────────────────────────────────────────────────────┤
│  07225-111-222 │ 8972...xxxxx     │ 01/01/2026 │ ⛔ פג תוקף    │
│  07225-333-444 │ 8972...xxxxx     │ -          │ ⛔ לא פעיל    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## שלב 4: טופס הפעלה משופר - חובת בחירת לקוח

### שינוי קריטי:
**לא ניתן יהיה להפעיל סים בלי לבחור לקוח קיים מהמערכת הראשית!**

### תהליך:

```
1. בחר סים מהרשימה
          ↓
2. 🔍 חפש ובחר לקוח קיים (חובה!)
   [אין לקוח? → כפתור "הוסף לקוח חדש"]
          ↓
3. בחר תאריכים
          ↓
4. ⚡ הפעל והשכר

📝 התוצאה:
- שליחה ל-Google Script להפעלה
- יצירת השכרה במערכת הראשית עם customer_id
- עדכון סטטוס הסים במלאי
```

### ממשק בחירת לקוח:

```
┌──────────────────────────────────────────────────┐
│  👤 בחירת לקוח (חובה)                           │
│  ───────────────────────────────────────────────  │
│  🔍 [חיפוש לפי שם או טלפון...]                   │
│                                                  │
│  ┌────────────────────────────────────────────┐  │
│  │ ישראל כהן - 050-1234567                   │  │
│  │ שרה לוי - 052-7654321                     │  │
│  │ דוד מזרחי - 054-9876543                   │  │
│  └────────────────────────────────────────────┘  │
│                                                  │
│  [+ הוסף לקוח חדש]                               │
└──────────────────────────────────────────────────┘
```

---

## שלב 5: סטטיסטיקות משופרות

### כרטיסים חדשים:

```
┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│ 🟢 12    │ │ 🟡 5     │ │ 🔴 2     │ │ ⛔ 8     │
│ זמינים   │ │ מושכרים │ │ באיחור   │ │ לא בתוקף │
└──────────┘ └──────────┘ └──────────┘ └──────────┘
```

- **זמינים להפעלה** - סימים בתוקף + לא מושכרים + פעילים
- **מושכרים** - סימים בהשכרה פעילה
- **באיחור** - סימים שלא הוחזרו ועברו תאריך סיום
- **לא בתוקף** - פג תוקף או לא פעילים ב-CellStation

---

## פרטים טכניים

### קבצים שישתנו:

1. **`src/components/cellstation/CellStationDashboard.tsx`**
   - שינוי מבנה הלשוניות
   - הוספת לוגיקת סטטוס משופרת
   - סטטיסטיקות חדשות

2. **`src/components/cellstation/ActiveRentalsTab.tsx`** (חדש)
   - לשונית השכרות פעילות עם סטטוס מערכת
   - אזהרות החלפת סים

3. **`src/components/cellstation/AvailableSimsTab.tsx`** (חדש)
   - סימים זמינים להפעלה
   - כרטיסים עם מידע מלא

4. **`src/components/cellstation/ExpiredSimsTab.tsx`** (חדש)
   - סימים שפג תוקפם

5. **`src/components/cellstation/ActivationTab.tsx`** (עדכון)
   - חובת בחירת לקוח
   - בדיקת זמינות סים לפני הפעלה

### לוגיקת סטטוס משולבת:

```typescript
// בדיקת זמינות סים
const getSimAvailability = (sim: SimCard) => {
  // 1. בדיקת תוקף
  if (isExpired(sim.expiry_date)) return 'expired';
  if (!sim.is_active) return 'inactive';
  
  // 2. בדיקה מול מערכת ראשית
  const inventoryItem = supabaseInventory.find(i => i.simNumber === sim.sim_number);
  if (!inventoryItem) return 'not_in_system';
  
  if (inventoryItem.status === 'rented') {
    const rental = findActiveRental(inventoryItem.id);
    if (rental?.status === 'overdue') return 'overdue_needs_replacement';
    return 'rented';
  }
  
  return 'available';
};
```

---

## סיכום השינויים

| לפני | אחרי |
|------|------|
| 4 לשוניות כלליות | 4 לשוניות ממוקדות לפי סטטוס |
| טבלה פשוטה של השכרות | כרטיסים עם סטטוס מפורט מהמערכת |
| אפשר להפעיל בלי לקוח | **חובה לבחור לקוח קיים** |
| אין אזהרות על סימים באיחור | אזהרה ברורה + כפתור החלפה |
| סטטיסטיקות בסיסיות | סטטיסטיקות חכמות לפי זמינות |

---

## סדר יישום

1. **יצירת קומפוננטות חדשות** - 3 לשוניות חדשות
2. **עדכון הדאשבורד הראשי** - מבנה חדש וסטטיסטיקות
3. **עדכון ActivationTab** - חובת בחירת לקוח
4. **בדיקות ותיקונים**

