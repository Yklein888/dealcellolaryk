
# ×ª×•×›× ×™×ª: ×©×™×¤×•×¨ ××¢×¨×›×ª ×”×”×©×›×¨×•×ª - ×¡× ×›×¨×•×Ÿ ×ª×•×§×£, ×”×ª×¨××•×ª, ×•×”×—×œ×¤×ª ×¡×™××™×

## ×¡×™×›×•×

×©×™×œ×•×‘ ×—×›× ×©×œ × ×ª×•× ×™ CellStation (×˜×‘×œ×ª `sim_cards`) ×¢× ××¢×¨×›×ª ×”×”×©×›×¨×•×ª ×”×¨××©×™×ª (`inventory` + `rentals`), ×›×•×œ×œ ×¡× ×›×¨×•×Ÿ ×ª×•×§×£ ××•×˜×•××˜×™, ×”×ª×¨××•×ª ×¢×œ ×¡×™××™× ×¤×’×™ ×ª×•×§×£, ×–×™×”×•×™ ×¦×•×¨×š ×‘×”×—×œ×¤×”, ×•×ª×”×œ×™×š ×”×¤×¢×œ×”+×”×—×œ×¤×” ××©×•×œ×‘.

---

## ×©×œ×‘ 1: ×¢×“×›×•×Ÿ ×¡×›××ª ××¡×“ ×”× ×ª×•× ×™×

×”×•×¡×¤×ª 3 ×©×“×•×ª ×—×“×©×™× ×œ×˜×‘×œ×ª `inventory`:

| ×©×“×” | ×¡×•×’ | ×ª×™××•×¨ |
|-----|------|--------|
| `cellstation_status` | TEXT | ×¡×˜×˜×•×¡ ×”×¡×™× ×‘-CellStation (active/rented ×•×›×•') |
| `last_sync` | TIMESTAMP | ×ª××¨×™×š ×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ |
| `needs_swap` | BOOLEAN (default FALSE) | ×”×× ×”×¡×™× ×“×•×¨×© ×”×—×œ×¤×” |

---

## ×©×œ×‘ 2: ×¡× ×›×¨×•×Ÿ ×ª×•×§×£ ×¡×™××™× ××•×˜×•××˜×™

### Hook ×—×“×©: `useSyncSimExpiry`
- ×‘×˜×¢×™× ×ª ×”×“×£, ××•×©×š × ×ª×•× ×™× ××˜×‘×œ×ª `sim_cards`
- ××¢×“×›×Ÿ ××ª ×˜×‘×œ×ª `inventory` ×‘×©×“×•×ª: `expiry_date`, `cellstation_status`, `last_sync`
- ×”×ª×××” ×œ×¤×™ `sim_number` (ICCID) ×›××–×”×” ×¢×™×§×¨×™
- ×¨×¥ ××•×˜×•××˜×™×ª ×›×œ 5 ×“×§×•×ª ×‘×¨×§×¢
- ×™×©×•×œ×‘ ×‘×¨××ª ×”-App ××• ×‘×“×£ ×”×”×©×›×¨×•×ª

---

## ×©×œ×‘ 3: ×–×™×”×•×™ ×¡×™××™× ×”×“×•×¨×©×™× ×”×—×œ×¤×”

### Hook ×—×“×©: `useDetectSwapNeeded`
- ×‘×•×“×§ ×¡×™××™× ×©××©×•×™×›×™× ×œ×”×©×›×¨×•×ª ×¤×¢×™×œ×•×ª/×‘××™×—×•×¨ ×‘-`inventory` (status=rented)
- ××¦×œ×™×‘ ××•×œ `sim_cards` - ×× ×”×¡×™× ××•×¤×™×¢ ×›×–××™×Ÿ (`is_rented=false`) ×‘-CellStation
- ××¡××Ÿ `needs_swap=true` ×¢×œ ×¤×¨×™×˜×™ ××œ××™ ×©×“×•×¨×©×™× ×”×—×œ×¤×”

---

## ×©×œ×‘ 4: ×ª×¦×•×’×” ××©×•×¤×¨×ª ×‘×‘×—×™×¨×ª ×¡×™× (NewRentalDialog)

×©×™× ×•×™ ×‘×ª×¦×•×’×ª ×¤×¨×™×˜×™ ×”××œ××™ ×‘×˜×•×¤×¡ "×”×©×›×¨×” ×—×“×©×”":

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¢ ×‘×ª×•×§×£    ×¡×™× 0722587082           â”‚
â”‚    ICCID: ...82  |  ×ª×•×§×£: 15/06/2026 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŸ¡ ×¤×’ ×ª×•×§×£  ×¡×™× 0722587090           â”‚
â”‚    ICCID: ...90  |  ×ª×•×§×£: 01/01/2026 â”‚
â”‚    (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×¢× ××–×”×¨×”)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”´ ×¦×¨×™×š ×”×—×œ×¤×”  ×¡×™× 0722587095        â”‚
â”‚    "×”×¡×™× ×”×•×—×–×¨ ××‘×œ ×¢×“×™×™×Ÿ ×¤×¢×™×œ"       â”‚
â”‚    (×ª×”×œ×™×š ×”×¤×¢×œ×”+×”×—×œ×¤×”)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- ×¡×™××•×Ÿ ×•×™×–×•××œ×™ ×¦×‘×¢×•× ×™ ×œ×¤×™ ×¡×˜×˜×•×¡: ×‘×ª×•×§×£ (×™×¨×•×§), ×¤×’ ×ª×•×§×£ (×¦×”×•×‘), ×¦×¨×™×š ×”×—×œ×¤×” (××“×•×)
- ×¡×™××™× ×¤×’×™ ×ª×•×§×£: ××¦×™×’×™× ×“×™××œ×•×’ ××–×”×¨×” ×œ×¤× ×™ ×‘×—×™×¨×”, ×¢× ××¤×©×¨×•×ª ×œ×”××©×™×š
- ×¡×™××™× ×©×“×•×¨×©×™× ×”×—×œ×¤×”: ××¤×¢×™×œ×™× ×ª×”×œ×™×š ×”×¤×¢×œ×”+×”×—×œ×¤×” ××©×•×œ×‘

---

## ×©×œ×‘ 5: ×“×™××œ×•×’ ××–×”×¨×” ×œ×¡×™× ×¤×’ ×ª×•×§×£

×›××©×¨ ×‘×•×—×¨×™× ×¡×™× ×©×ª×•×§×¤×• ×¤×’:
- ××•×¦×’ ×“×™××œ×•×’ ×¢× ×ª××¨×™×š ×”×ª×¤×•×’×”
- ×”×¡×‘×¨: "×œ×¤× ×™ ×”×”×¤×¢×œ×” ×™×© ×œ×”××¨×™×š ××ª ×”×ª×•×§×£ ×‘××ª×¨ CellStation"
- ×›×¤×ª×•×¨×™ "×”××©×š ×‘×›×œ ×–××ª" / "×‘×™×˜×•×œ"
- ×× ×”××©×ª××© ×××©×™×š, ×”×¡×™× × ×•×¡×£ ×œ×”×©×›×¨×” ×¢× ×¡×™××•×Ÿ ××–×”×¨×”

---

## ×©×œ×‘ 6: ×¨×›×™×‘ ×”×¤×¢×œ×” + ×”×—×œ×¤×ª ×¡×™× ××©×•×œ×‘

### ×¨×›×™×‘ ×—×“×©: `ActivateWithSwapDialog`

×›××©×¨ ×‘×•×—×¨×™× ×¡×™× ×¢× `needs_swap=true`:
1. ×”××©×ª××© ×¨×•××” ×”×¡×‘×¨ ×©×”×¡×™× ×”×™×©×Ÿ ×¢×“×™×™×Ÿ ×¤×¢×™×œ
2. ×‘×•×—×¨ ×¡×™× ×—×“×© ××”××œ××™ ×œ×”×¤×¢×œ×”
3. ×œ×—×™×¦×” ×¢×œ "×”×ª×—×œ ×ª×”×œ×™×š" ××‘×¦×¢×ª:
   - ×©×œ×™×—×ª ×‘×§×©×ª ×”×¤×¢×œ×” ×œ×¡×™× ×”×—×“×© (×“×¨×š Edge Function)
   - ×©×œ×™×—×ª ×‘×§×©×ª ×”×—×œ×¤×ª ×¡×™× (replace_sim) ×œ-Google Apps Script
   - ×ª×¦×•×’×ª ×¡×˜×˜×•×¡ ×‘×–××Ÿ ×××ª: "××¤×¢×™×œ..." -> "××—×œ×™×£..." -> "×”×•×©×œ×"

---

## ×©×œ×‘ 7: ×¢×“×›×•×Ÿ Edge Function `cellstation-sync`

×”×•×¡×¤×ª ×©×œ×‘ 3 ×œ×¡× ×›×¨×•×Ÿ - ×¡× ×›×¨×•×Ÿ ×ª×•×§×£ ×œ×˜×‘×œ×ª `inventory`:
- ×œ××—×¨ ×¡× ×›×¨×•×Ÿ `sim_cards`, ×’× ××¢×“×›×Ÿ ××ª `inventory.expiry_date` ×•-`inventory.cellstation_status` ×œ×¤×™ ICCID

---

## ×§×‘×¦×™× ×©×™×•×¦×¨×•

| ×§×•×‘×¥ | ×ª×™××•×¨ |
|------|--------|
| `src/hooks/useSyncSimExpiry.ts` | ×¡× ×›×¨×•×Ÿ ×ª×•×§×£ ××•×˜×•××˜×™ sim_cards -> inventory |
| `src/hooks/useDetectSwapNeeded.ts` | ×–×™×”×•×™ ×¡×™××™× ×©×“×•×¨×©×™× ×”×—×œ×¤×” |
| `src/components/rentals/ExpiryWarningDialog.tsx` | ×“×™××œ×•×’ ××–×”×¨×” ×œ×¡×™× ×¤×’ ×ª×•×§×£ |
| `src/components/rentals/ActivateWithSwapDialog.tsx` | ×ª×”×œ×™×š ×”×¤×¢×œ×”+×”×—×œ×¤×” ××©×•×œ×‘ |

## ×§×‘×¦×™× ×©×™×¢×•×“×›× ×•

| ×§×•×‘×¥ | ×©×™× ×•×™ |
|------|-------|
| `src/components/rentals/NewRentalDialog.tsx` | ×ª×¦×•×’×” ×¦×‘×¢×•× ×™×ª, ×“×™××œ×•×’ ××–×”×¨×”, ×©×™×œ×•×‘ ×”×—×œ×¤×” |
| `src/hooks/useRental.tsx` | ×˜×¢×™× ×ª ×©×“×•×ª ×—×“×©×™× (needs_swap, cellstation_status) |
| `supabase/functions/cellstation-sync/index.ts` | ×¡× ×›×¨×•×Ÿ ×ª×•×§×£ ×’× ×œ-inventory |
| `src/App.tsx` ××• `src/pages/Rentals.tsx` | ×©×™×œ×•×‘ hooks ×—×“×©×™× |

## ××™×’×¨×¦×™×™×ª DB

```sql
ALTER TABLE inventory ADD COLUMN IF NOT EXISTS cellstation_status TEXT;
ALTER TABLE inventory ADD COLUMN IF NOT EXISTS last_sync TIMESTAMP;
ALTER TABLE inventory ADD COLUMN IF NOT EXISTS needs_swap BOOLEAN DEFAULT FALSE;
```
