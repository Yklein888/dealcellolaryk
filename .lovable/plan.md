
# ×ª×•×›× ×™×ª ××©×•×œ×‘×ª: ×©×™×¤×•×¨ ××¢×¨×›×ª ×”×”×©×›×¨×•×ª + ××¢×§×‘ ×©×™×—×•×ª ××•×˜×•××˜×™

## ×¡×™×›×•× ×›×œ×œ×™
×ª×•×›× ×™×ª ×–×• ××©×œ×‘×ª ××ª ×›×œ ×”×“×¨×™×©×•×ª ×œ×¤×¨×•×™×§×˜ ××—×“ ××§×™×£:
1. ×©×™×¤×•×¨ ×××©×§ ×™×¦×™×¨×ª ×”×©×›×¨×” ×—×“×©×”
2. ××¢×§×‘ ×©×™×—×•×ª ××œ× (×™×“× ×™×•×ª ×•××•×˜×•××˜×™×•×ª)
3. ×—×™×•×’ ××•×˜×•××˜×™ ×‘-14:00 ×‘×™×•× ×”×¨××©×•×Ÿ ×©×œ ×”××™×—×•×¨

---

## ×—×œ×§ ×: ×©×™×¤×•×¨ ×××©×§ ×”×”×©×›×¨×•×ª

### 1. ×—×œ×•×Ÿ ×”×©×›×¨×” ×¨×—×‘ (Horizontal Layout)

**××” ×™×©×ª× ×”:**
- ×—×œ×•×Ÿ ×”×”×©×›×¨×” ×™×”×¤×•×š ×œ×¨×•×—×‘ ××œ× ×¢×œ ×”××¡×š
- ×¤×¨×™×¡×” ×‘-2 ×¢××•×“×•×ª: ×©×××œ (×œ×§×•×— + ×ª××¨×™×›×™×) | ×™××™×Ÿ (×‘×—×™×¨×ª ×¤×¨×™×˜×™×)
- ×›×œ ×”××™×“×¢ × ×¨××” ×‘×œ×™ ×’×œ×™×œ×”

**×§×•×“:**
```text
DialogContent: max-w-6xl w-[98vw]
Grid: grid-cols-1 lg:grid-cols-2 gap-6
```

### 2. ×’×¨×™×“ ×•×™×–×•××œ×™ ×œ××œ××™

**××” ×™×©×ª× ×”:**
- ×›×¨×˜×™×¡×™× ×’×“×•×œ×™× ×•×¦×‘×¢×•× ×™×™× ×œ×¤×™ ×§×˜×’×•×¨×™×”
- ×›×¤×ª×•×¨ "×”×•×¡×£ ×œ×¡×œ" ×‘×•×œ×˜ ×‘×›×œ ×›×¨×˜×™×¡
- ××™× ×“×™×§×¦×™×” ×‘×¨×•×¨×” ×œ×¤×¨×™×˜ ×©× ×‘×—×¨ (×’×‘×•×œ ×™×¨×•×§ + ×¡×™××Ÿ V)

**×¦×‘×¢×™ ×§×˜×’×•×¨×™×•×ª:**

| ×§×˜×’×•×¨×™×” | ×¦×‘×¢ ×¨×§×¢ | ×¦×‘×¢ ×’×‘×•×œ |
|---------|---------|----------|
| ×¡×™× ×××¨×™×§××™ | bg-red-50 | border-red-200 |
| ×¡×™× ××™×¨×•×¤××™ | bg-blue-50 | border-blue-200 |
| ××›×©×™×¨ ×¤×©×•×˜ | bg-green-50 | border-green-200 |
| ×¡×××¨×˜×¤×•×Ÿ | bg-purple-50 | border-purple-200 |
| ××•×“× | bg-orange-50 | border-orange-200 |
| × ×˜×¡×˜×™×§ | bg-cyan-50 | border-cyan-200 |

### 3. ×œ×•×— ×©× ×” ×•×™×–×•××œ×™ ×œ×ª××¨×™×›×™×

**××” ×™×©×ª× ×”:**
- Popover ×¢× Calendar ×‘××§×•× ×©×“×•×ª ×ª××¨×™×š
- ×‘×—×™×¨×ª ×˜×•×•×— ×ª××¨×™×›×™× ×™×©×™×¨×•×ª ×¢×œ ×”×œ×•×—
- ×”×¦×’×ª ××¡×¤×¨ ×”×™××™× ×•××—×™×¨ ×¦×¤×•×™

**×œ×œ× ×›×¤×ª×•×¨×™ ×§×™×¦×•×¨** - ×¨×§ ×œ×•×— ×©× ×” × ×§×™

### 4. ×‘×× ×“×œ×™× ×¤×•×¤×•×œ×¨×™×™× ××©×•×¤×¨×™×

**××” ×™×©×ª× ×”:**
- ×›×¨×˜×™×¡×™ ×‘×× ×“×œ ×’×“×•×œ×™× ×™×•×ª×¨ ×¢× ×¢×™×¦×•×‘ premium
- ×”×¦×’×ª ××—×™×¨ ××©×•×¢×¨ ×œ×›×œ ×‘×× ×“×œ
- ××™×™×§×•× ×™× ×’×“×•×œ×™× ×™×•×ª×¨

---

## ×—×œ×§ ×‘: ××¢×¨×›×ª ××¢×§×‘ ×©×™×—×•×ª

### 5. ×˜×‘×œ×ª call_logs ×—×“×©×”

**×¡×›××”:**

| ×©×“×” | ×¡×•×’ | ×ª×™××•×¨ |
|-----|-----|-------|
| id | uuid | ××–×”×” ×™×™×—×•×“×™ |
| entity_type | text | 'rental' ××• 'repair' |
| entity_id | uuid | ××–×”×” ×”×”×©×›×¨×”/×ª×™×§×•×Ÿ |
| customer_id | uuid | ××–×”×” ×”×œ×§×•×— (nullable) |
| customer_phone | text | ××¡×¤×¨ ×˜×œ×¤×•×Ÿ |
| call_status | text | pending / answered / no_answer / busy / callback |
| campaign_id | text | ××–×”×” ×§××¤×™×™×Ÿ ××™××•×ª ×”××©×™×— |
| call_type | text | 'manual' ××• 'automatic' |
| call_message | text | ×ª×•×›×Ÿ ×”×”×•×“×¢×” ×©× ×©×œ×—×” |
| created_at | timestamp | ×–××Ÿ ×”×©×™×—×” |
| updated_at | timestamp | ×–××Ÿ ×¢×“×›×•×Ÿ ×”×¡×˜×˜×•×¡ |

**RLS Policy:**
```sql
CREATE POLICY "Authenticated users can manage call_logs"
ON public.call_logs FOR ALL
USING (true)
WITH CHECK (true);
```

### 6. ×¢×“×›×•×Ÿ Edge Function - yemot-call

**×©×™× ×•×™×™×:**
- ×©××™×¨×ª ×¨×©×•××” ×‘-call_logs ×œ×¤× ×™ ×©×œ×™×—×ª ×”×©×™×—×”
- ×”×—×–×¨×ª campaign_id ×œ×××©×§
- ×¤×¨××˜×¨×™× ×—×“×©×™×: entityType, entityId, callType

**×§×•×“ ×¢×™×§×¨×™:**
```typescript
interface YemotCallRequest {
  phone: string;
  message: string;
  callerId?: string;
  campaignType?: 'repair_ready' | 'rental_reminder';
  // New fields for logging
  entityType?: 'rental' | 'repair';
  entityId?: string;
  customerId?: string;
  callType?: 'manual' | 'automatic';
}

// Save call log to database
const { data: logData } = await supabase.from('call_logs').insert({
  entity_type: entityType,
  entity_id: entityId,
  customer_id: customerId,
  customer_phone: cleanPhone,
  call_status: 'pending',
  campaign_id: campaignId,
  call_type: callType || 'manual',
  call_message: message,
}).select().single();
```

### 7. Edge Function ×—×“×© - yemot-callback (Webhook)

**××˜×¨×”:** ×§×‘×œ×ª ×“×™×•×•×—×™ ×¡×˜×˜×•×¡ ××™××•×ª ×”××©×™×—

**×§×•×“:**
```typescript
// supabase/functions/yemot-callback/index.ts
serve(async (req) => {
  const { campaignId, status, phone } = await parseYemotResponse(req);
  
  // Map Yemot status to our status
  const mappedStatus = mapYemotStatus(status);
  
  // Update call log
  await supabase.from('call_logs')
    .update({ 
      call_status: mappedStatus,
      updated_at: new Date().toISOString()
    })
    .eq('campaign_id', campaignId);
});
```

**Mapping ×¡×˜×˜×•×¡×™×:**

| ×¡×˜×˜×•×¡ ×™××•×ª | ×¡×˜×˜×•×¡ ××¢×¨×›×ª |
|------------|-------------|
| answered | answered |
| noanswer | no_answer |
| busy | busy |
| callback | callback |

---

## ×—×œ×§ ×’: ×—×™×•×’ ××•×˜×•××˜×™ ×‘××™×—×•×¨

### 8. Edge Function ×—×“×© - process-overdue-calls

**×œ×•×’×™×§×”:**
1. ××¦×™××ª ×”×©×›×¨×•×ª ×©×”×¤×›×• ×œ××™×—×•×¨ **×”×™×•×** (endDate = ××ª××•×œ)
2. ×‘×“×™×§×” ×× ×›×‘×¨ ×”×ª×§×©×¨× ×• ×”×™×•×
3. ×©×œ×™×¤×ª ×˜×œ×¤×•×Ÿ ×”×œ×§×•×—
4. ×§×¨×™××” ×œ-yemot-call ×œ×‘×™×¦×•×¢ ×”×©×™×—×”
5. ×©××™×¨×ª ×”×¨×©×•××” ×‘-call_logs ×¢× callType='automatic'

**×”×•×“×¢×” ××•×˜×•××˜×™×ª:**
```text
×©×œ×•× [×©× ×œ×§×•×—], ×–×•×”×™ ×ª×–×›×•×¨×ª ×××¢×¨×›×ª ×“×™×œ ×¡×œ×•×œ×¨. 
××•×¢×“ ×”×”×—×–×¨×” ×©×œ ×”×¦×™×•×“ ×”××•×©×›×¨ ×¢×‘×¨. 
×× × ×¦×•×¨ ×§×©×¨ ×œ×”×—×–×¨×ª ×”×¦×™×•×“ ×‘×”×§×“×. ×ª×•×“×” ×¨×‘×”.
```

### 9. ×ª×–××•×Ÿ ×‘-14:00 ×›×œ ×™×•× (pg_cron)

**SQL:**
```sql
SELECT cron.schedule(
  'process-overdue-calls-daily-14',
  '0 14 * * *',
  $$
  SELECT net.http_post(
    url:='https://qifcynwnxmtoxzpskmmt.supabase.co/functions/v1/process-overdue-calls',
    headers:=jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer [ANON_KEY]'
    ),
    body:='{}'::jsonb
  );
  $$
);
```

**×©×¢×ª ×”×¤×¢×œ×”:** 14:00 (×©×¢×•×Ÿ ×™×©×¨××œ = UTC+2/3)
- ×‘×—×•×¨×£: 12:00 UTC
- ×‘×§×™×¥: 11:00 UTC

---

## ×—×œ×§ ×“: ×××©×§ ×”×™×¡×˜×•×¨×™×™×ª ×©×™×—×•×ª

### 10. ×§×•××¤×•× × ×˜×” ×—×“×©×” - CallHistoryBadge

**××™×§×•×:** ×œ×™×“ ×›×œ ×›×¤×ª×•×¨ "×”×ª×§×©×¨ ×œ×œ×§×•×—"

**×ª×¦×•×’×”:**
- Badge ×¢× ××¡×¤×¨ ×”×©×™×—×•×ª (×œ×“×•×’××”: "3 ×©×™×—×•×ª")
- ×¦×‘×¢ ×œ×¤×™ ×¡×˜×˜×•×¡ ××—×¨×•×Ÿ: ×™×¨×•×§ (×¢× ×”), ××“×•× (×œ× ×¢× ×”), ××¤×•×¨ (×××ª×™×Ÿ)
- ×œ×—×™×¦×” ×¤×•×ª×—×ª Popover ×¢× ×”×™×¡×˜×•×¨×™×” ××œ××”

**×¢×™×¦×•×‘:**
```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ 3 ×©×™×—×•×ª                    [×¡×’×•×¨]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  29/01/2026 14:00  âœ… ×¢× ×”    (××•×˜×•××˜×™)  â”‚
â”‚  28/01/2026 10:30  âŒ ×œ× ×¢× ×”  (×™×“× ×™)    â”‚
â”‚  27/01/2026 09:15  â³ ×××ª×™×Ÿ   (×™×“× ×™)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11. ×©×™×œ×•×‘ ×‘×“×£ ×”×©×›×¨×•×ª

**×©×™× ×•×™×™× ×‘-Rentals.tsx:**
- ×”×•×¡×¤×ª CallHistoryBadge ×œ×™×“ ×›×¤×ª×•×¨ "×”×•×“×¢ ×œ×œ×§×•×—"
- ×¢×“×›×•×Ÿ notifyRentalCustomer ×œ×©×œ×•×— entityType + entityId
- ×”×¦×’×ª ×”×™×¡×˜×•×¨×™×” ×œ×¤× ×™ ×©×œ×™×—×ª ×©×™×—×” ×—×“×©×”

### 12. ×©×™×œ×•×‘ ×‘×“×£ ×ª×™×§×•× ×™×

**×©×™× ×•×™×™× ×‘-Repairs.tsx:**
- ×”×•×¡×¤×ª CallHistoryBadge ×œ×™×“ ×›×¤×ª×•×¨ "×”×•×“×¢ ×œ×œ×§×•×—"
- ×¢×“×›×•×Ÿ notifyCustomer ×œ×©×œ×•×— entityType + entityId
- ×”×¦×’×ª ×”×™×¡×˜×•×¨×™×” ×œ×¤× ×™ ×©×œ×™×—×ª ×©×™×—×” ×—×“×©×”

---

## ×—×œ×§ ×”: ×¢×“×›×•× ×™ Types ×•-Hook

### 13. ×¢×“×›×•×Ÿ src/types/rental.ts

```typescript
// New type for call logs
export interface CallLog {
  id: string;
  entityType: 'rental' | 'repair';
  entityId: string;
  customerId?: string;
  customerPhone: string;
  callStatus: 'pending' | 'answered' | 'no_answer' | 'busy' | 'callback';
  campaignId?: string;
  callType: 'manual' | 'automatic';
  callMessage?: string;
  createdAt: string;
  updatedAt?: string;
}
```

### 14. ×¢×“×›×•×Ÿ src/hooks/useRental.tsx

**×¤×•× ×§×¦×™×•×ª ×—×“×©×•×ª:**
- `getCallLogs(entityType, entityId)` - ×©×œ×™×¤×ª ×”×™×¡×˜×•×¨×™×™×ª ×©×™×—×•×ª
- `addCallLog(log)` - ×”×•×¡×¤×ª ×¨×©×•××ª ×©×™×—×” (× ×¢×©×” ×‘-Edge Function)

---

## ×¡×™×›×•× ×§×‘×¦×™× ×œ×¢×“×›×•×Ÿ

| ×§×•×‘×¥ | ×¤×¢×•×œ×” | ×ª×™××•×¨ |
|------|-------|-------|
| `src/pages/Rentals.tsx` | ×¢×“×›×•×Ÿ | ×××©×§ ×¨×—×‘, ×’×¨×™×“ ×•×™×–×•××œ×™, ×œ×•×— ×©× ×”, ×‘×× ×“×œ×™×, CallHistoryBadge |
| `src/pages/Repairs.tsx` | ×¢×“×›×•×Ÿ | CallHistoryBadge, ×¢×“×›×•×Ÿ notifyCustomer |
| `src/types/rental.ts` | ×¢×“×›×•×Ÿ | ×”×•×¡×¤×ª ×˜×™×¤×•×¡ CallLog |
| `src/hooks/useRental.tsx` | ×¢×“×›×•×Ÿ | ×¤×•× ×§×¦×™×•×ª call_logs |
| `src/components/CallHistoryBadge.tsx` | ×—×“×© | ×§×•××¤×•× × ×˜×ª ×”×™×¡×˜×•×¨×™×™×ª ×©×™×—×•×ª |
| `supabase/functions/yemot-call/index.ts` | ×¢×“×›×•×Ÿ | ×©××™×¨×ª ×œ×•×’, ×”×—×–×¨×ª campaign_id |
| `supabase/functions/yemot-callback/index.ts` | ×—×“×© | Webhook ×œ×§×‘×œ×ª ×¡×˜×˜×•×¡ |
| `supabase/functions/process-overdue-calls/index.ts` | ×—×“×© | ×—×™×•×’ ××•×˜×•××˜×™ ×‘-14:00 |
| **Migration** | ×—×“×© | ×˜×‘×œ×ª call_logs + pg_cron job |

---

## ×”×¢×¨×” ×—×©×•×‘×”: ×”×’×“×¨×ª Webhook ×‘×™××•×ª ×”××©×™×—

×›×“×™ ×œ×§×‘×œ ×“×™×•×•×—×™ ×¡×˜×˜×•×¡ ××•×˜×•××˜×™×™×, ×™×© ×œ×”×’×“×™×¨ ××ª ×”-URL ×”×‘× ×‘×××©×§ ×™××•×ª ×”××©×™×—:
```
https://qifcynwnxmtoxzpskmmt.supabase.co/functions/v1/yemot-callback
```

×× ××™×Ÿ ××¤×©×¨×•×ª ×œ×”×’×“×™×¨ webhook, × ×•×¡×™×£ ×›×¤×ª×•×¨ ×™×“× ×™ "×¢×“×›×Ÿ ×¡×˜×˜×•×¡" ×©×™××¤×©×¨ ×œ××©×ª××© ×œ×¡××Ÿ ×× ×”×œ×§×•×— ×¢× ×” ××• ×œ×.

---

## ×¡×“×¨ ×‘×™×¦×•×¢

```text
×©×œ×‘ 1: ×™×¦×™×¨×ª ×˜×‘×œ×ª call_logs (Migration)
   â†“
×©×œ×‘ 2: ×¢×“×›×•×Ÿ yemot-call ×œ×©××™×¨×ª ×œ×•×’×™×
   â†“
×©×œ×‘ 3: ×™×¦×™×¨×ª yemot-callback (Webhook)
   â†“
×©×œ×‘ 4: ×™×¦×™×¨×ª process-overdue-calls + pg_cron
   â†“
×©×œ×‘ 5: ×™×¦×™×¨×ª CallHistoryBadge ×§×•××¤×•× × ×˜×”
   â†“
×©×œ×‘ 6: ×¢×“×›×•×Ÿ Rentals.tsx (×××©×§ ×¨×—×‘ + ×’×¨×™×“ + ×©×™×—×•×ª)
   â†“
×©×œ×‘ 7: ×¢×“×›×•×Ÿ Repairs.tsx (×©×™×—×•×ª)
   â†“
×©×œ×‘ 8: ×¢×“×›×•×Ÿ types + hook
```
